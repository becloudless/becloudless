name: Auto Update Vendor Hash
on:
  push:
    branches-ignore:
      - main
    paths:
      - "go.mod"
      - "go.sum"

jobs:
  update-vendor-hash:
    if: github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-24.04

    permissions:
      contents: write

    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@v2
        id: github-app-token
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ steps.github-app-token.outputs.token }} # Use the App token to checkout

      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-25.05

      - run: |          
          if nix build --no-link --print-build-logs ./nixos#becloudless 2> /tmp/log; then
            echo >@2 no need to update vendorHash
            exit 0
          fi
          
          hash="$(grep 'got:' /tmp/log | awk '{print $2}')"
          echo "hash=$hash"

          if [[ -z "$hash" ]]; then
            echo >@2 hash is empty
            exit 1
          fi

          sed -e "s#vendorHash =.*\$#vendorHash = \"$hash\";#g" -i nixos/flake.nix

      - uses: iarekylew00t/verified-bot-commit@v2.1.1
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ steps.github-app-token.outputs.token }} # Use the App token to commit changes
          message: "Auto Update Vendor Hash"
          files: |
            nixos/flake.nix
