# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Auto Update Vendor Hash
on:
  push:
    branches-ignore:
      - main
    paths:
      - "go.mod"
      - "go.sum"

jobs:
  update-vendor-hash:
    runs-on: ubuntu-24.04

    permissions:
      contents: write

    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        id: github-app-token
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.ref_name }}
          token: ${{ steps.github-app-token.outputs.token }} # Use the App token to checkout

      - uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31
        with:
          nix_path: nixpkgs=channel:nixos-25.05

      - run: |          
          if nix build --no-link --print-build-logs ./nixos#becloudless 2> /tmp/log; then
            echo >@2 no need to update vendorHash
            exit 0
          fi
          
          hash="$(grep 'got:' /tmp/log | awk '{print $2}')"
          echo "hash=$hash"

          if [[ -z "$hash" ]]; then
            echo >@2 hash is empty
            exit 1
          fi

          sed -e "s#vendorHash =.*\$#vendorHash = \"$hash\";#g" -i nixos/flake.nix

      - uses: iarekylew00t/verified-bot-commit@d7e8eea1f154881e1f9d70a3fd933e740148b7f4 # v2.1.1
        with:
          ref: ${{ github.ref_name }}
          token: ${{ steps.github-app-token.outputs.token }} # Use the App token to commit changes
          message: "Auto Update Vendor Hash"
          files: |
            nixos/flake.nix
