apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: lldap-postgresql
  namespace: lldap
spec:
  instances: 2

  # https://cloudnative-pg.io/docs/1.28/ssl_connections
  postgresql:
    pg_hba:
      - hostssl app all all cert

  certificates:
    clientCASecret: lldap-postgresql-ca
    # replication is required so cnpg do not look for ca.key in the clientCASecret, which is not the format of cert-manager
    replicationTLSSecret: lldap-postgresql-replication-tls
    serverTLSSecret: lldap-postgresql-tls
    serverCASecret: lldap-postgresql-tls

  storage:
    storageClass: longhorn-single-local-replica
    size: 1Gi

  backup:
    className: longhorn-snapshot

#    retentionPolicy: "60d"
#    barmanObjectStore:
#      destinationPath: s3://lldap-postgresql-backup
#      endpointURL: https://lldap-postgresql-backup.lldap.svc.cluster.local
#      endpointCA:
#        name: lldap-postgresql-backup-tls
#        key: ca.crt
#      s3Credentials:
#        accessKeyId:
#          name: lldap-postgresql-backup
#          key: MINIO_ROOT_USER
#        secretAccessKey:
#          name: lldap-postgresql-backup
#          key: MINIO_ROOT_PASSWORD
#      wal:
#        compression: gzip
#      data:
#        compression: gzip
